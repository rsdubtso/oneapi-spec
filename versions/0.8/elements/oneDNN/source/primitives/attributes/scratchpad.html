

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Scratchpad Mode &mdash; oneAPI Specification 0.8 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../../../_static/favicons.png"/>
  
  
  

  
  <script type="text/javascript" src="../../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
        <script src="../../../../../_static/jquery.js"></script>
        <script src="../../../../../_static/underscore.js"></script>
        <script src="../../../../../_static/doctools.js"></script>
        <script src="../../../../../_static/language_data.js"></script>
        <script src="../../../../../_static/custom.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <link rel="next" title="Quantization" href="quantization.html" />
    <link rel="prev" title="Attributes" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="https://oneapi.com" class="icon icon-home"> oneAPI Specification
          

          
            
            <img src="../../../../../_static/oneAPI-rgb-rev-100.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../architecture.html">Software Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../library-interop.html">Library Interoperability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../elements.html">oneAPI Elements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../dpcpp/source/index.html">DPC++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../oneDPL/source/index.html">oneDPL</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">oneDNN</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../conventions.html">Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../execution_model/index.html">Execution Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../data_model/index.html">Data model</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Primitives</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../general.html">Common definitions</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Attributes</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">Scratchpad Mode</a></li>
<li class="toctree-l4"><a class="reference internal" href="quantization.html">Quantization</a></li>
<li class="toctree-l4"><a class="reference internal" href="post-ops.html">Post-ops</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#attribute-related-error-handling">Attribute Related Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#api">API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../batch_normalization.html">Batch Normalization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../binary.html">Binary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../concat.html">Concat</a></li>
<li class="toctree-l3"><a class="reference internal" href="../convolution.html">Convolution and Deconvolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="../eltwise.html">Elementwise</a></li>
<li class="toctree-l3"><a class="reference internal" href="../inner-product.html">Inner Product</a></li>
<li class="toctree-l3"><a class="reference internal" href="../layer_normalization.html">Layer normalization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../logsoftmax.html">LogSoftmax</a></li>
<li class="toctree-l3"><a class="reference internal" href="../lrn.html">Local Response Normalization</a></li>
<li class="toctree-l3"><a class="reference internal" href="../matmul.html">Matrix Multiplication</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pooling.html">Pooling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../reorder.html">Reorder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../resampling.html">Resampling</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rnn.html">RNN</a></li>
<li class="toctree-l3"><a class="reference internal" href="../shuffle.html">Shuffle</a></li>
<li class="toctree-l3"><a class="reference internal" href="../softmax.html">Softmax</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sum.html">Sum</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#id1">Open Source Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#implementation-notes">Implementation Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../index.html#testing">Testing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../oneCCL/source/index.html">oneCCL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../l0/source/index.html">Level Zero</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../oneDAL/source/index.html">oneDAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../oneTBB/source/nested-index.html">oneTBB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../oneVPL/source/index.html">oneVPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../oneMKL/source/index.html">oneMKL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../contributors.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../versions.html">HTML and PDF Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../notices.html">Legal Notices and Disclaimers</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">oneAPI Specification</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../../index.html">oneAPI Specification</a> &raquo;</li>
        
          
          <li><a href="../../index.html">oneDNN</a> </li>
          
        
          
        
          
        
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/oneapi-src/oneapi-spec/blob/master/source/elements/oneDNN/source/primitives/attributes/scratchpad.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="scratchpad-mode">
<h1>Scratchpad Mode<a class="headerlink" href="#scratchpad-mode" title="Permalink to this headline">¶</a></h1>
<p>Some primitives might require a temporary buffer while performing their
computations. For instance, the operations that do not have enough independent
work to utilize all cores on a system might use parallelization over the
reduction dimension (the K dimension in the GEMM notation). In this case
different threads compute partial results in private temporary buffers, and
then the private results are added to produce the final result. Another
example is using matrix multiplication (GEMM) to implement convolution. Before
calling GEMM, the source activations need to be transformed using the
<code class="docutils literal notranslate"><span class="pre">im2col</span></code> operation. The transformation result is written to a temporary
buffer that is then used as an input for the GEMM.</p>
<p>In both of these examples, the temporary buffer is no longer required once the
primitive computation is completed. oneDNN refers to such kind of a memory
buffer as a <em>scratchpad</em>.</p>
<p>Both types of implementation might need extra space for the reduction in case
there are too few independent tasks. The amount of memory required by the
<code class="docutils literal notranslate"><span class="pre">im2col</span></code> transformation is proportional to the size of the source image
multiplied by the weights spatial size. The size of a buffer for reduction is
proportional to the tensor size to be reduced (e.g., <code class="docutils literal notranslate"><span class="pre">diff_weights</span></code> in the
case of backward by weights) multiplied by the number of threads in the
reduction groups (the upper bound is the total number of threads).</p>
<p>By contrast, some other primitives might require very little extra space. For
instance, one of the implementation of the <a class="reference internal" href="../sum.html#_CPPv4N4dnnl3sumE" title="dnnl::sum"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">dnnl::sum</span></code></a> primitive requires
temporary space only to store the pointers to data for each and every input
array (that is, the size of the scratchpad is <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">*</span> <span class="pre">sizeof(void</span> <span class="pre">*)</span></code>, where
<code class="docutils literal notranslate"><span class="pre">n</span></code> is the number of summands).</p>
<p>oneDNN supports two modes for handling scratchpads:</p>
<dl class="cpp enum">
<dt id="_CPPv4N4dnnl15scratchpad_modeE">
<span id="_CPPv3N4dnnl15scratchpad_modeE"></span><span id="_CPPv2N4dnnl15scratchpad_modeE"></span><span class="target" id="group__dnnl__api__attributes_1gac24d40ceea0256c7d6cc3a383a0fa07f"></span><em class="property">enum </em><code class="sig-prename descclassname">dnnl<code class="sig-prename descclassname">::</code></code><code class="sig-name descname">scratchpad_mode</code><a class="headerlink" href="#_CPPv4N4dnnl15scratchpad_modeE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Scratchpad mode. </p>
<p><em>Values:</em></p>
<dl class="cpp enumerator">
<dt id="_CPPv4N4dnnl15scratchpad_mode7libraryE">
<span id="_CPPv3N4dnnl15scratchpad_mode7libraryE"></span><span id="_CPPv2N4dnnl15scratchpad_mode7libraryE"></span><span class="target" id="group__dnnl__api__attributes_1ggac24d40ceea0256c7d6cc3a383a0fa07fad521f765a49c72507257a2620612ee96"></span><em class="property">enumerator </em><code class="sig-name descname">library</code><a class="headerlink" href="#_CPPv4N4dnnl15scratchpad_mode7libraryE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>The library manages the scratchpad allocation. There may be multiple implementation-specific policies that can be configured via mechanisms that fall outside of the scope of this specification. </p>
</dd></dl>

<dl class="cpp enumerator">
<dt id="_CPPv4N4dnnl15scratchpad_mode4userE">
<span id="_CPPv3N4dnnl15scratchpad_mode4userE"></span><span id="_CPPv2N4dnnl15scratchpad_mode4userE"></span><span class="target" id="group__dnnl__api__attributes_1ggac24d40ceea0256c7d6cc3a383a0fa07faee11cbb19052e40b07aac0ca060c23ee"></span><em class="property">enumerator </em><code class="sig-name descname">user</code><a class="headerlink" href="#_CPPv4N4dnnl15scratchpad_mode4userE" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>The user manages the scratchpad allocation by querying and providing the scratchpad memory to primitives. This mode is thread-safe as long as the scratchpad buffers are not used concurrently by two primitive executions. </p>
</dd></dl>

</dd></dl>

<p>The scratchpad mode is controlled though the
<a class="reference internal" href="index.html#_CPPv4N4dnnl14primitive_attr19set_scratchpad_modeE15scratchpad_mode" title="dnnl::primitive_attr::set_scratchpad_mode"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">dnnl::primitive_attr::set_scratchpad_mode()</span></code></a> primitive attributes.</p>
<p>If the user provides scratchpad memory to a primitive, this memory must be
created using the same engine that the primitive uses.</p>
<p>All primitives support both scratchpad modes.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Primitives are not thread-safe by default. The only way to make the
primitive execution fully thread-safe is to use the
<a class="reference internal" href="#_CPPv4N4dnnl15scratchpad_mode4userE" title="dnnl::scratchpad_mode::user"><code class="xref cpp cpp-any docutils literal notranslate"><span class="pre">dnnl::scratchpad_mode::user</span></code></a> mode and not pass the same scratchpad
memory to two primitives that are executed concurrently.</p>
</div>
<div class="section" id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="library-manages-scratchpad">
<h3>Library Manages Scratchpad<a class="headerlink" href="#library-manages-scratchpad" title="Permalink to this headline">¶</a></h3>
<p>As mentioned above, this is a default behavior. We only want to highlight how
a user can query the amount of memory consumed by a primitive due to a
scratchpad.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Use default attr, hence the library allocates scratchpad</span>
<span class="n">dnnl</span><span class="o">::</span><span class="n">primitive</span><span class="o">::</span><span class="n">primitive_desc</span> <span class="n">op_pd</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="cm">/* other arguments */</span><span class="p">);</span>

<span class="c1">// Print how much memory would be hold by a primitive due to scratchpad</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;primitive will use &quot;</span>
          <span class="o">&lt;&lt;</span> <span class="n">op_pd</span><span class="p">.</span><span class="n">query_s64</span><span class="p">(</span><span class="n">dnnl</span><span class="o">::</span><span class="n">query</span><span class="o">::</span><span class="n">memory_consumption_s64</span><span class="p">)</span>
          <span class="o">&lt;&lt;</span> <span class="s">&quot; bytes&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="c1">// In this case scratchpad is internal, hence user visible scratchpad memory</span>
<span class="c1">// descriptor should be empty:</span>
<span class="k">auto</span> <span class="n">zero_md</span> <span class="o">=</span> <span class="n">dnnl</span><span class="o">::</span><span class="n">memory</span><span class="o">::</span><span class="n">desc</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h3>Library Manages Scratchpad<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create an empty (default) attributes</span>
<span class="n">dnnl</span><span class="o">::</span><span class="n">primitive_attr</span> <span class="n">attr</span><span class="p">;</span>

<span class="c1">// Default scratchpad mode is `library`:</span>
<span class="n">assert</span><span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">get_scratchpad_mode</span><span class="p">()</span> <span class="o">==</span> <span class="n">dnnl</span><span class="o">::</span><span class="n">scratchpad_mode</span><span class="o">::</span><span class="n">library</span><span class="p">);</span>

<span class="c1">// Set scratchpad mode to `user`</span>
<span class="n">attr</span><span class="p">.</span><span class="n">set_scratchpad_mode</span><span class="p">(</span><span class="n">dnnl</span><span class="o">::</span><span class="n">scratchpad_mode</span><span class="o">::</span><span class="n">user</span><span class="p">);</span>

<span class="c1">// Create a primitive descriptor with custom attributes</span>
<span class="n">dnnl</span><span class="o">::</span><span class="n">primitive</span><span class="o">::</span><span class="n">primitive_desc</span> <span class="n">op_pd</span><span class="p">(</span><span class="n">op_d</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">engine</span><span class="p">);</span>

<span class="c1">// Query the scratchpad memory descriptor</span>
<span class="n">dnnl</span><span class="o">::</span><span class="n">memory</span><span class="o">::</span><span class="n">desc</span> <span class="n">scratchpad_md</span> <span class="o">=</span> <span class="n">op_pd</span><span class="p">.</span><span class="n">scratchpad_desc</span><span class="p">();</span>

<span class="c1">// Note, that a primitive doesn&#39;t consume memory in this configuration:</span>
<span class="n">assert</span><span class="p">(</span><span class="n">op_pd</span><span class="p">.</span><span class="n">query_s64</span><span class="p">(</span><span class="n">dnnl</span><span class="o">::</span><span class="n">query</span><span class="o">::</span><span class="n">memory_consumption_s64</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

<span class="c1">// Create a primitive</span>
<span class="n">dnnl</span><span class="o">::</span><span class="n">primitive</span> <span class="n">prim</span><span class="p">(</span><span class="n">op_pd</span><span class="p">);</span>

<span class="c1">// ... more code ..</span>

<span class="c1">// Create a scratchpad memory</span>
<span class="c1">// NOTE: if scratchpad is not required for a particular primitive the</span>
<span class="c1">//       scratchpad_md.get_size() will return 0. It is fine to have</span>
<span class="c1">//       scratchpad_ptr == nullptr in this case.</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">scratchpad_ptr</span> <span class="o">=</span> <span class="n">user_memory_manager</span><span class="o">::</span><span class="n">allocate</span><span class="p">(</span><span class="n">scratchpad_md</span><span class="p">.</span><span class="n">get_size</span><span class="p">());</span>
<span class="c1">// NOTE: engine here must much the engine of the primitive</span>
<span class="n">dnnl</span><span class="o">::</span><span class="n">memory</span> <span class="n">scratchpad</span><span class="p">(</span><span class="n">scratchpad_md</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">scratchpad_ptr</span><span class="p">);</span>

<span class="c1">// Pass a scratchpad memory to a primitive</span>
<span class="n">prim</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="p">{</span> <span class="cm">/* other arguments */</span><span class="p">,</span>
        <span class="p">{</span><span class="n">DNNL_ARG_SCRATCHPAD</span><span class="p">,</span> <span class="n">scratchpad</span><span class="p">}});</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="quantization.html" class="btn btn-neutral float-right" title="Quantization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Attributes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Intel Corporation

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>