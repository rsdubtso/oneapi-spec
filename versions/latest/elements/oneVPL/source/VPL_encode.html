

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>&lt;no title&gt; &mdash; oneAPI Specification 0.8 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../../_static/favicons.png"/>
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script src="../../../_static/custom.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="https://oneapi.com" class="icon icon-home"> oneAPI Specification
          

          
            
            <img src="../../../_static/oneAPI-rgb-rev-100.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">Software Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library-interop.html">Library Interoperability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../elements.html">oneAPI Elements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dpcpp/source/index.html">DPC++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../oneDPL/source/index.html">oneDPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../oneDNN/source/index.html">oneDNN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../oneCCL/source/index.html">oneCCL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../l0/source/index.html">Level Zero</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../oneDAL/source/index.html">oneDAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../oneTBB/source/nested-index.html">oneTBB</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">oneVPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../oneMKL/source/index.html">oneMKL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributors.html">Contributors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../versions.html">HTML and PDF Versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notices.html">Legal Notices and Disclaimers</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">oneAPI Specification</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">oneAPI Specification</a> &raquo;</li>
        
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/oneapi-src/oneapi-spec/blob/master/source/elements/oneVPL/source/VPL_encode.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p>The <a class="reference internal" href="index.html#_CPPv4N3vpl6EncodeE" title="vpl::Encode"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">vpl::Encode</span></code></a> class implements elementary stream encode from raw frame to encoded bitstream.</p>
<div class="graphviz"><img src="../../../_images/graphviz-4ac45ad507f7a264cc96bffe557d445a1e22c588.png" alt="digraph {
  rankdir=LR;
  Bitstream [shape=record label=&quot;Bitstream&quot; ];
  Encode [shape=record  label=&quot;Encode&quot;];
  Raw [shape=rect];
  Raw-&gt;Encode-&gt;Bitstream;
}" class="graphviz" /></div>
<p><strong>Supported bitstream formats</strong></p>
<ul class="simple">
<li><p>h264</p></li>
<li><p>h265</p></li>
</ul>
<p><strong>EncodeFrame C++ interface</strong>:</p>
<p>The encode function <a class="reference internal" href="index.html#_CPPv4N3vpl6Encode11EncodeFrameEP8vplm_memPv" title="vpl::Encode::EncodeFrame"><code class="xref cpp cpp-func docutils literal notranslate"><span class="pre">vpl::Encode::EncodeFrame()</span></code></a> interface is</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">size_t</span> <span class="n">Encode</span><span class="o">::</span><span class="n">EncodeFrame</span><span class="p">(</span><span class="n">vplm_mem</span><span class="o">*</span> <span class="n">image</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pbs_out</span><span class="p">);</span>
</pre></div>
</div>
<p><strong>States</strong>:</p>
<p>During execution, state communicates what the application should do next.</p>
<div class="graphviz"><img src="../../../_images/graphviz-cdc2b5e0967c3cb88d344a801ac5ea2fd9e22363.png" alt="digraph {
  rankdir=LR

  start
  READ_INPUT
  ERROR
  OUTPUT_BUFFER_FULL
  OUTPUT_EXCEEDS_BUFFER_SIZE
  END_OF_OPERATION
  end

  start-&gt;READ_INPUT

  READ_INPUT-&gt;READ_INPUT[label=&quot;almost everything happens here&quot;]
  READ_INPUT-&gt;ERROR[label=&quot;internal error&quot;]
  ERROR-&gt;READ_INPUT

  READ_INPUT-&gt;OUTPUT_BUFFER_FULL[label=&quot;output size&gt;remaining buffer size&quot;]
  OUTPUT_BUFFER_FULL-&gt;READ_INPUT

  READ_INPUT-&gt;OUTPUT_EXCEEDS_BUFFER_SIZE[label=&quot;output size&gt;total buffer size&quot;]
  OUTPUT_EXCEEDS_BUFFER_SIZE-&gt;READ_INPUT

  READ_INPUT-&gt;END_OF_OPERATION[label=&quot;no more to process&quot;]
  END_OF_OPERATION-&gt;end
}" class="graphviz" /></div>
<table class="docutils align-default">
<colgroup>
<col style="width: 39%" />
<col style="width: 61%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>State</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>READ_INPUT</p></td>
<td><p>workstream can read raw frame input</p></td>
</tr>
<tr class="row-odd"><td><p>ERROR</p></td>
<td><p>an error occurred during processing, try again</p></td>
</tr>
<tr class="row-even"><td><p>OUTPUT_BUFFER_FULL</p></td>
<td><p>output size &gt; remaining space in the output bitstream buffer</p></td>
</tr>
<tr class="row-odd"><td><p>OUTPUT_EXCEEDS_BUFFER_SIZE</p></td>
<td><p>output size&gt; total buffer size</p></td>
</tr>
</tbody>
</table>
<p><strong>Settings</strong>:</p>
<p>Encode configuration parameters are specified in <a class="reference internal" href="index.html#_CPPv4N3vpl15VplParamsEncodeE" title="vpl::VplParamsEncode"><code class="xref cpp cpp-class docutils literal notranslate"><span class="pre">vpl::VplParamsEncode</span></code></a>,
which controls per session and per frame settings of the encode operations.</p>
<p><strong>Data model</strong>:</p>
<p>VPL allocates pools of VPL Memory used by decode and consumers of decoded frames.  The application is expected to manage reference counts.  Only surfaces with no external references can be used to decode new frames.</p>
<div class="graphviz"><img src="../../../_images/graphviz-1802ab7a9117c7a31eb61945551dc346242493de.png" alt="digraph  {
 rankdir=LR
 node [shape=record];
 struct1 [label=&quot;&lt;f0&gt; surface pool|&lt;f1&gt; DecodeFrame&quot;];
 struct3 [label=&quot;&lt;f1&gt; rest of pipeline&quot;];

 struct1:f1 -&gt; struct3:f1 [label=&quot;VPL Memory&quot;];
}" class="graphviz" /></div>
<p><strong>Sample code</strong>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;vpl/vpl.hpp&quot;</span><span class="cp"></span>
<span class="cp">#define BUFFER_SIZE 1024 * 1024</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>

  <span class="c1">// Find all the devices in the system and select a preferred device</span>
  <span class="n">DeviceInfo</span> <span class="o">*</span><span class="n">dinfo</span> <span class="o">=</span> <span class="n">new</span> <span class="n">DeviceInfo</span><span class="p">();</span>
  <span class="n">DeviceInstance</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">GetPreferredDevice</span><span class="p">(</span><span class="n">VPL_WORKSTREAM_ENCODE</span><span class="p">);</span>

  <span class="c1">// Get encode preset</span>
  <span class="n">VplParamsEncode</span> <span class="o">*</span><span class="n">dconfig</span> <span class="o">=</span> <span class="n">dinfo</span><span class="o">-&gt;</span><span class="n">GetPreset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">m_dtype</span><span class="p">,</span> <span class="n">VPL_WORKSTREAM_ENCODE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">m_id</span><span class="p">);</span>

  <span class="c1">// Create an Encode workstream and a device context on the device</span>
  <span class="n">Encode</span> <span class="o">*</span><span class="n">ws</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Encode</span><span class="p">(</span><span class="n">dconfig</span><span class="p">,</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

  <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">pbsout</span><span class="o">=</span><span class="n">new</span> <span class="kt">uint8_t</span><span class="p">[</span><span class="n">BUFFER_SIZE</span><span class="p">];</span>
  <span class="n">VplFile</span><span class="o">*</span> <span class="n">fInput</span> <span class="o">=</span> <span class="n">vplOpenFile</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;rb&quot;</span><span class="p">);</span>
  <span class="kt">FILE</span><span class="o">*</span> <span class="n">fOutput</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;out.h264&quot;</span><span class="p">,</span><span class="s">&quot;wb&quot;</span><span class="p">);</span>

  <span class="n">vplm_mem</span><span class="o">*</span> <span class="n">decimage</span><span class="p">;</span>
  <span class="n">vplm_image_info</span> <span class="n">info</span><span class="o">=</span><span class="p">{};</span>
  <span class="n">info</span><span class="p">.</span><span class="n">width</span><span class="o">=</span><span class="mi">300</span><span class="p">;</span>
  <span class="n">info</span><span class="p">.</span><span class="n">height</span><span class="o">=</span><span class="mi">300</span><span class="p">;</span>
  <span class="n">info</span><span class="p">.</span><span class="n">format</span><span class="o">=</span><span class="n">VPLM_PIXEL_FORMAT_NV12</span><span class="p">;</span>
  <span class="n">vplm_create_cpu_image</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">decimage</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="n">vplStatus</span> <span class="n">sts</span><span class="o">=</span><span class="n">vplReadData</span><span class="p">(</span><span class="n">fInput</span><span class="p">,</span><span class="n">decimage</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sts</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="n">vplm_ref</span><span class="p">(</span><span class="n">decimage</span><span class="p">);</span>

    <span class="kt">size_t</span> <span class="n">nbytesout</span><span class="o">=</span><span class="n">ws</span><span class="o">-&gt;</span><span class="n">EncodeFrame</span><span class="p">(</span><span class="n">decimage</span><span class="p">,</span><span class="n">pbsout</span><span class="p">);</span>
    <span class="n">fwrite</span><span class="p">(</span><span class="n">pbsout</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nbytesout</span><span class="p">,</span> <span class="n">fOutput</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
    <span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

  <span class="p">}</span>
  <span class="n">puts</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>

  <span class="n">vplCloseFile</span><span class="p">(</span><span class="n">fInput</span><span class="p">);</span>
  <span class="n">fclose</span><span class="p">(</span><span class="n">fOutput</span><span class="p">);</span>

  <span class="n">delete</span><span class="p">[]</span> <span class="n">pbsout</span><span class="p">;</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Intel Corporation

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>